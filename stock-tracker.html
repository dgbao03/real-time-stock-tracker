<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>STOCK PRICE TRACKER</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="text-center mb-4 text-primary">üìà STOCK PRICE TRACKER</h1>

    <!-- Symbol Input -->
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <div class="input-group">
                <input
                        type="text"
                        id="symbolInput"
                        class="form-control"
                        placeholder="e.g. AAPL or META"
                />
                <button class="btn btn-primary" onclick="switchSymbol()">Switch Symbol</button>
            </div>
        </div>
    </div>

    <!-- Real-time Price Display -->
    <div class="row text-center mb-4">
        <div class="col">
            <h4>Current Price:</h4>
            <p id="price" class="fs-3 fw-bold text-success">Waiting...</p>
            <p id="errorMsg" class="text-danger fw-bold"></p>
        </div>
    </div>

    <!-- News Section -->
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h4 class="mb-3">üì∞ Latest News</h4>
            <ul id="newsList" class="list-group">
                <!-- News will be loaded here -->
            </ul>
            <p id="newsError" class="text-danger fw-bold mt-2"></p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let stompClient = null;
    let currentSymbol = null;
    let subscription = null;
    let errorSubscription = null;
    let sessionId = null;

    function connect() {
        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log("‚úÖ Connected: " + frame);

            // Extract sessionId
            const urlParts = stompClient.ws._transport.url.split("/");
            sessionId = urlParts[urlParts.length - 2]; // usually the second to last part
            console.log("üìå Session ID: ", sessionId);
        });
    }

    function switchSymbol() {
        const newSymbol = document.getElementById("symbolInput").value.trim().toUpperCase();
        if (!newSymbol) {
            alert("Please enter a symbol!");
            return;
        }

        // Reset UI
        document.getElementById("price").innerText = "Waiting...";
        document.getElementById("errorMsg").innerText = "";
        document.getElementById("newsError").innerText = "";

        // Unsubscribe old topics
        if (subscription) subscription.unsubscribe();
        if (errorSubscription) errorSubscription.unsubscribe();

        // Subscribe to price topic
        subscription = stompClient.subscribe(`/topic/price${newSymbol}`, function (message) {
            const price = parseFloat(message.body);
            document.getElementById("price").innerText = `$${price.toFixed(2)}`;
            document.getElementById("errorMsg").innerText = "";
        });

        // Subscribe to error topic
        if (sessionId) {
            errorSubscription = stompClient.subscribe(`/topic/errors/${sessionId}`, function (message) {
                const errorMsg = message.body || "An unknown error occurred.";
                console.error("‚ùå Received error:", errorMsg);
                document.getElementById("errorMsg").innerText = errorMsg;
                document.getElementById("price").innerText = "Waiting...";
            });
        } else {
            console.warn("‚ö†Ô∏è sessionId not ready. Error subscription skipped.");
        }

        // Send symbol tracking to server
        stompClient.send("/app/trackingSymbol", {}, JSON.stringify({
            currentSymbol: currentSymbol,
            newSymbol: newSymbol
        }));

        currentSymbol = newSymbol;
        fetchNews(newSymbol);
    }

    function fetchNews(symbol) {
        const newsList = document.getElementById("newsList");
        const newsError = document.getElementById("newsError");

        newsList.innerHTML = "";
        newsError.innerText = "";

        fetch(`http://localhost:1511/company-news?symbol=${symbol}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch news. Server responded with ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data || data.length === 0) {
                    const li = document.createElement("li");
                    li.className = "list-group-item text-muted";
                    li.textContent = "No news available.";
                    newsList.appendChild(li);
                    return;
                }

                data.forEach(item => {
                    const li = document.createElement("li");
                    li.className = "list-group-item";

                    const headline = document.createElement("a");
                    headline.href = item.url;
                    headline.target = "_blank";
                    headline.textContent = item.headline;
                    headline.className = "fw-bold d-block text-decoration-none mb-1";

                    const summary = document.createElement("p");
                    summary.textContent = item.summary;
                    summary.className = "mb-1";

                    const date = document.createElement("small");
                    const dateObj = new Date(item.datetime * 1000);
                    date.textContent = `Source: ${item.source} ‚Ä¢ ${dateObj.toLocaleString()}`;
                    date.className = "text-muted";

                    li.appendChild(headline);
                    li.appendChild(summary);
                    li.appendChild(date);

                    newsList.appendChild(li);
                });
            })
            .catch(error => {
                console.error("‚ùå Failed to fetch news:", error);
                newsError.innerText = "Error loading news: " + error.message;
            });
    }

    connect();
</script>
</body>
</html>
